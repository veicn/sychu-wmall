"use strict";var app=getApp();Page({data:{goodsListId:[],goodsList:[],allGoodsPrice:0,yunPrice:0,allGoodsAndYunPrice:0,youhuijine:0,curCoupon:null,couponsIndex:0,serviceType:2,cpid:0,coupons:[],ycoidList:[],ycoidIndex:0,ycoid:0,userInfo:{}},getCartSettle:function(){var t=this;app.wxRequest("/commodity/settlement",{scids:t.data.goodsListId.join(",")},function(e){if(1==e.code){var a=e.data.coupons,o=e.data.ycoid;!!a&&a.forEach(function(t){t.textShow="["+t.dictValue+"]优惠"+t.couponPrice+"元"}),t.setData({goodsList:e.data.list,coupons:a.length>0?[{textShow:"不使用优惠券",cpid:""}].concat(a):[{textShow:"无可用优惠券",cpid:""}],discount:e.data.discount,allGoodsPrice:e.data.sumPrice,allGoodsAndYunPrice:e.data.sumPrice,ycoid:e.data.ycoid,ycoidList:o>0?["不使用薏米",e.data.ycoid+"薏米"]:["无薏米"],yunPrice:e.data.freight})}})},countCartSettle:function(){var t=this;app.wxRequest("/commodity/settlementCount",{scids:t.data.goodsListId.join(","),serviceType:t.data.serviceType,cpid:t.data.cpid},function(e){1==e.code&&t.setData({allGoodsAndYunPrice:e.data.sumPrice,yunPrice:e.data.freight})})},bindCouponsChange:function(t){var e=this.data.coupons[t.detail.value];this.setData({couponsIndex:t.detail.value,curCoupon:e,serviceType:1,cpid:e.cpid}),e.cpid&&this.countCartSettle()},bindYcoidChange:function(t){var e=this.data.ycoidList[t.detail.value];this.setData({ycoidIndex:t.detail.value,ycoid:e,serviceType:2}),e>0&&this.countCartSettle()},onLoad:function(){var t=this,e=[],a=app.getCookie("shopCartInfo");a&&a.shopList&&(e=a.shopList.filter(function(t){return t.active}));for(var o=[],i=0;i<e.length;i++)o.push(e[i].scid);t.setData({goodsListId:o}),t.getCartSettle()},createOrder:function(){var t=this;if(!t.data.curAddressData)return void wx.showModal({title:"提 示",content:"请先设置您的收货地址！",showCancel:!1});var e={expressName:t.data.curAddressData.linkMan,expressMobile:t.data.curAddressData.mobile,expressAddress:t.data.curAddressData.address,remark:"",scids:t.data.goodsListId.join(","),serviceType:t.data.serviceType,cpid:t.data.cpid};app.wxRequest("/order/saveOrder",e,function(t){app.clearCookie("shopCartInfo"),app.wxPay(t.data.oid,"/pages/user/order-list/index")})},addAddress:function(){var t=this;wx.chooseAddress({success:function(e){t.setData({curAddressData:{linkMan:e.userName,mobile:e.telNumber,address:e.provinceName+" "+e.cityName+" "+e.countyName+" "+e.detailInfo}})}})},selectAddress:function(){var t=this;wx.chooseAddress({success:function(e){t.setData({curAddressData:{linkMan:e.userName,mobile:e.telNumber,address:e.provinceName+" "+e.cityName+" "+e.countyName+" "+e.detailInfo}})}})},bindChangeCoupon:function(t){var e=t.detail.value[0]-1;if(-1==e)return void this.setData({youhuijine:0,curCoupon:null});this.setData({youhuijine:this.data.coupons[e].couponPrice,curCoupon:this.data.coupons[e]})}});