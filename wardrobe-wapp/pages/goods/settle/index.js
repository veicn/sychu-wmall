"use strict";var app=getApp();Page({data:{goodsListId:[],goodsList:[],allGoodsPrice:0,yunPrice:0,allGoodsAndYunPrice:0,curCoupon:null,couponsIndex:0,serviceType:"",cpid:0,coupons:[],hasCoupons:!1,ycoidList:[],ycoidIndex:0,ycoid:0,useYcoid:0,hasYcoid:!1,userInfo:{}},onShareAppMessage:null,getCartSettle:function(){var e=this;app.wxRequest("/commodity/settlement",{scids:e.data.goodsListId.join(",")},function(t){if(1==t.code){var a=t.data.coupons,s=t.data.ycoid,o=[];!!a&&a.forEach(function(e){1==e.status&&(e.textShow=e.dictValue2,o.push(e))}),e.setData({goodsList:t.data.list,coupons:o.length>0?[{textShow:"不使用优惠券",cpid:""}].concat(o):[{textShow:"无可用优惠券",cpid:""}],hasCoupons:o.length>0,couponPrice:0,allGoodsPrice:t.data.sumOldDisPrice,allGoodsAndYunPrice:t.data.sumPrice,ycoid:t.data.ycoid,useYcoid:0,ycoidList:s>0?[{textShow:"不使用薏米",ycoid:"0"},{textShow:t.data.ycoid+"薏米",ycoid:t.data.ycoid}]:[{textShow:"没有薏米",ycoid:"0"}],hasYcoid:s>0,yunPrice:t.data.freight})}})},countCartSettle:function(){var e=this;app.wxRequest("/commodity/settlementCount",{scids:e.data.goodsListId.join(","),serviceType:e.data.serviceType,cpid:e.data.cpid},function(t){1==t.code&&e.setData({allGoodsAndYunPrice:t.data.sumPrice,yunPrice:t.data.freight,couponPrice:t.data.couponPrice,useYcoid:t.data.useYcoid})})},bindCouponsChange:function(e){var t=e.detail.value;if(t>0){var a=this.data.coupons[t];this.setData({couponsIndex:t,curCoupon:a,serviceType:1,cpid:a.cpid}),this.countCartSettle(),this.data.ycoidIndex>0&&this.setData({ycoidIndex:0})}},bindYcoidChange:function(e){var t=e.detail.value;if(t>0){this.data.ycoidList[t];this.setData({ycoidIndex:t,serviceType:2}),this.countCartSettle(),this.data.couponsIndex>0&&this.setData({cpid:"",couponsIndex:0})}},onLoad:function(){var e=this,t=[],a=app.getCookie("shopCartInfo");a&&a.shopList&&(t=a.shopList.filter(function(e){return e.active}));for(var s=[],o=0;o<t.length;o++)s.push(t[o].scid);e.setData({goodsListId:s}),e.getCartSettle()},createOrder:function(){var e=this;if(!e.data.curAddressData)return void wx.showModal({title:"提 示",content:"请先设置您的收货地址！",showCancel:!1});var t={expressName:e.data.curAddressData.linkMan,expressMobile:e.data.curAddressData.mobile,expressAddress:e.data.curAddressData.address,scids:e.data.goodsListId.join(","),payType:1};1==e.data.serviceType?(t.serviceType=e.data.serviceType,t.cpid=e.data.cpid):2==e.data.serviceType&&(t.serviceType=e.data.serviceType),app.wxRequest("/order/saveOrder",t,function(e){1==e.code?(app.clearCookie("shopCartInfo"),app.wxPay(e.data.oid,"/pages/user/order-list/index")):app.showToast("创建订单失败","none")},function(){app.showToast("创建订单错误","none")})},addAddress:function(){var e=this;wx.chooseAddress({success:function(t){e.setData({curAddressData:{linkMan:t.userName,mobile:t.telNumber,address:t.provinceName+" "+t.cityName+" "+t.countyName+" "+t.detailInfo}})}})},selectAddress:function(){var e=this;wx.chooseAddress({success:function(t){e.setData({curAddressData:{linkMan:t.userName,mobile:t.telNumber,address:t.provinceName+" "+t.cityName+" "+t.countyName+" "+t.detailInfo}})}})}});