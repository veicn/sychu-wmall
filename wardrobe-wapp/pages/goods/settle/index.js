"use strict";var app=getApp();Page({data:{goodsListId:[],goodsList:[],isNeedLogistics:0,allGoodsPrice:0,yunPrice:0,allGoodsAndYunPrice:0,goodsJsonStr:"",orderType:"",youhuijine:0,curCoupon:null,hasNoCoupons:!0,coupons:[],hasNoPoint:!0,point:0,userInfo:{}},getUserCouponsList:function(){var e=this;app.wxRequest("/user/userCouponList",{},function(o){1==o.code&&e.setData({coupons:o.data.coupons})})},getUserInfo:function(){var e=this;app.wxRequest("/user/userCenter",{},function(o){e.setData({userInfo:o.data}),e.data.userInfo.couponCount>0&&(e.setData({hasNoCoupons:!1,couponCount:e.data.userInfo.couponCount}),e.getUserCouponsList()),e.data.userInfo.point>0&&e.setData({hasNoPoint:!1,point:e.data.userInfo.point})})},onLoad:function(){var e=this,o=[],s=app.getCookie("shopCartInfo");s&&s.shopList&&(o=s.shopList.filter(function(e){return e.active}));for(var a=0,t=[],n=0;n<o.length;n++){var r=o[n];a+=r.price*r.number,t.push(o[n].scid)}e.setData({isNeedLogistics:1,goodsList:o,allGoodsPrice:a,allGoodsAndYunPrice:a,goodsListId:t}),e.getUserInfo()},createOrder:function(){var e=this;if(!e.data.curAddressData)return void wx.showModal({title:"提 示",content:"请先设置您的收货地址！",showCancel:!1});var o={expressName:e.data.curAddressData.linkMan,expressMobile:e.data.curAddressData.mobile,expressAddress:e.data.curAddressData.address,remark:"",scids:e.data.goodsListId.join(","),serviceType:"",cpid:""};e.data.curCoupon&&(o.serviceType=2,o.cpid=e.data.curCoupon.id),o.calculate="true",app.wxRequest("/order/saveOrder",o,function(e){app.clearCookie("shopCartInfo"),app.wxPay(e.data.oid,"/pages/user/order-list/index")})},addAddress:function(){var e=this;wx.chooseAddress({success:function(o){e.setData({curAddressData:{linkMan:o.userName,mobile:o.telNumber,address:o.provinceName+" "+o.cityName+" "+o.countyName+" "+o.detailInfo}})}})},selectAddress:function(){var e=this;wx.chooseAddress({success:function(o){e.setData({curAddressData:{linkMan:o.userName,mobile:o.telNumber,address:o.provinceName+" "+o.cityName+" "+o.countyName+" "+o.detailInfo}})}})},bindChangeCoupon:function(e){var o=e.detail.value[0]-1;if(-1==o)return void this.setData({youhuijine:0,curCoupon:null});this.setData({youhuijine:this.data.coupons[o].couponPrice,curCoupon:this.data.coupons[o]})}});