"use strict";var app=getApp();Page({data:{goodsListId:[],goodsList:[],allGoodsPrice:0,yunPrice:0,allGoodsAndYunPrice:0,curCoupon:null,couponsIndex:0,serviceType:"",cpid:0,coupons:[],hasCoupons:!1,ycoidList:[],ycoidIndex:0,ycoid:0,useYcoid:0,hasYcoid:!1,userBalance:0,payType:1,payTypeIndex:0,payTypeList:[{value:1,text:"微信支付"},{value:2,text:"余额支付"}]},onShareAppMessage:null,getCartSettle:function(){var e=this;app.wxRequest("/commodity/settlement",{scids:e.data.goodsListId.join(",")},function(a){if(1==a.code){var t=a.data.coupons,s=a.data.ycoid,o=[];!!t&&t.forEach(function(e){1==e.status&&(e.textShow=e.dictValue2,o.push(e))}),e.setData({goodsList:a.data.list,coupons:o.length>0?[{textShow:"不使用优惠券",cpid:""}].concat(o):[{textShow:"无可用优惠券",cpid:""}],hasCoupons:o.length>0,couponPrice:0,allGoodsPrice:a.data.sumOldDisPrice,allGoodsAndYunPrice:a.data.sumPrice,ycoid:a.data.ycoid,useYcoid:0,ycoidList:s>0?[{textShow:"不使用薏米",ycoid:"0"},{textShow:a.data.ycoid+"薏米",ycoid:a.data.ycoid}]:[{textShow:"没有薏米",ycoid:"0"}],hasYcoid:s>0,yunPrice:a.data.freight})}})},countCartSettle:function(){var e=this;app.wxRequest("/commodity/settlementCount",{scids:e.data.goodsListId.join(","),serviceType:e.data.serviceType,cpid:e.data.cpid},function(a){1==a.code&&e.setData({allGoodsAndYunPrice:a.data.sumPrice,yunPrice:a.data.freight,couponPrice:a.data.couponPrice,useYcoid:a.data.useYcoid})})},getUserBalance:function(){var e=this;app.wxRequest("/account/userAccountBalance",{},function(a){1==a.code&&e.setData({userBalance:a.data.balance})})},bindPayTypeChange:function(e){var a=e.detail.value;this.setData({payTypeIndex:a,payType:this.data.payTypeList[a].value})},bindCouponsChange:function(e){var a=e.detail.value;if(a>0){var t=this.data.coupons[a];this.setData({couponsIndex:a,curCoupon:t,serviceType:1,cpid:t.cpid}),this.countCartSettle(),this.data.ycoidIndex>0&&this.setData({ycoidIndex:0})}},bindYcoidChange:function(e){var a=e.detail.value;if(a>0){this.data.ycoidList[a];this.setData({ycoidIndex:a,serviceType:2}),this.countCartSettle(),this.data.couponsIndex>0&&this.setData({cpid:"",couponsIndex:0})}},onLoad:function(){var e=this,a=[],t=app.getCookie("shopCartInfo");t&&t.shopList&&(a=t.shopList.filter(function(e){return e.active}));for(var s=[],o=0;o<a.length;o++)s.push(a[o].scid);e.setData({goodsListId:s}),e.getCartSettle()},createOrder:function(){var e=this;if(!e.data.curAddressData)return void wx.showModal({title:"提 示",content:"请先设置您的收货地址！",showCancel:!1});if(2==e.data.payType&&e.data.allGoodsAndYunPrice>e.data.userBalance)return void wx.showModal({title:"提 示",content:"您的余额不足，请先去充值或者取消选择微信支付！",cancelText:"取消",confirmText:"去充值",success:function(e){e.confirm&&app.redirect("/pages/user/recharge/index")}});var a={expressName:e.data.curAddressData.linkMan,expressMobile:e.data.curAddressData.mobile,expressAddress:e.data.curAddressData.address,scids:e.data.goodsListId.join(","),payType:e.data.payType};1==e.data.serviceType?(a.serviceType=e.data.serviceType,a.cpid=e.data.cpid):2==e.data.serviceType&&(a.serviceType=e.data.serviceType),app.wxRequest("/order/saveOrder",a,function(e){1==e.code?(app.clearCookie("shopCartInfo"),app.wxPay(e.data.oid,"/pages/user/order-list/index")):app.showToast("创建订单失败","none")},function(){app.showToast("创建订单错误","none")})},addAddress:function(){var e=this;wx.chooseAddress({success:function(a){e.setData({curAddressData:{linkMan:a.userName,mobile:a.telNumber,address:a.provinceName+" "+a.cityName+" "+a.countyName+" "+a.detailInfo}})}})},selectAddress:function(){var e=this;wx.chooseAddress({success:function(a){e.setData({curAddressData:{linkMan:a.userName,mobile:a.telNumber,address:a.provinceName+" "+a.cityName+" "+a.countyName+" "+a.detailInfo}})}})}});