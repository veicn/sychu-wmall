"use strict";var app=getApp();Page({data:{goodsListId:[],goodsList:[],allGoodsPrice:0,yunPrice:0,allGoodsAndYunPrice:0,curCoupon:null,couponsIndex:0,serviceType:2,cpid:0,coupons:[],hasCoupons:!1,ycoidList:[],ycoidIndex:0,ycoid:0,useYcoid:0,hasYcoid:!1,userInfo:{},did:"",dbids:[]},onShareAppMessage:null,getCartSettle:function(){var d=this;app.wxRequest("/rfid/readRfid",{did:this.data.did},function(t){if(1==t.code){var i=t.data.coupons,e=t.data.ycoid,a=t.data.commoditys,o=[],c=[];!!i&&i.forEach(function(d){1==d.status&&(d.textShow=d.dictValue,o.push(d))}),!!a&&a.forEach(function(d){c.push(d.dbid)}),d.setData({dbids:c.join(","),goodsList:t.data.commoditys,coupons:o.length>0?[{textShow:"不使用优惠券",cpid:""}].concat(o):[{textShow:"无可用优惠券",cpid:""}],hasCoupons:o.length>0,couponPrice:0,allGoodsPrice:t.data.sumOldDisPrice,allGoodsAndYunPrice:t.data.sumPrice,ycoid:t.data.ycoid,useYcoid:0,ycoidList:e>0?[{textShow:"不使用薏米",ycoid:"0"},{textShow:t.data.ycoid+"薏米",ycoid:t.data.ycoid}]:[{textShow:"没有薏米",ycoid:"0"}],hasYcoid:e>0,yunPrice:t.data.freight})}})},countCartSettle:function(){var d=this;app.wxRequest("/commodity/settlementRfidCount",{dbids:d.data.dbids,serviceType:d.data.serviceType,cpid:d.data.cpid},function(t){1==t.code&&d.setData({allGoodsAndYunPrice:t.data.sumPrice,yunPrice:t.data.freight,couponPrice:t.data.couponPrice,useYcoid:t.data.useYcoid})})},bindCouponsChange:function(d){var t=this.data.coupons[d.detail.value];this.setData({couponsIndex:d.detail.value,curCoupon:t,serviceType:1,cpid:t.cpid}),t.cpid&&this.countCartSettle()},bindYcoidChange:function(d){this.data.ycoidList[d.detail.value];this.setData({ycoidIndex:d.detail.value,serviceType:2}),this.countCartSettle()},onLoad:function(d){var t=this;t.setData({did:d.did}),t.getCartSettle(d.did)},createOrder:function(){var d=this,t={dbids:d.data.dbids,serviceType:d.data.serviceType,cpid:d.data.cpid};app.wxRequest("/order/saveRfidOrder",t,function(d){1==d.code&&app.wxPay(d.data.oid,"/pages/user/order-list/index")})}});