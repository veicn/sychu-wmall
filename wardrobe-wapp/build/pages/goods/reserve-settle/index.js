"use strict";var app=getApp();Page({data:{goodsListId:[],goodsList:[],allGoodsPrice:0,yunPrice:0,allGoodsAndYunPrice:0,curCoupon:null,couponsIndex:0,serviceType:2,cpid:0,coupons:[],hasCoupons:!1,ycoidList:[],ycoidIndex:0,ycoid:0,useYcoid:0,hasYcoid:!1,userInfo:{},did:"",dbids:[],userBalance:0,payType:1,payTypeIndex:0,payTypeList:[{value:1,text:"微信支付"},{value:2,text:"余额支付"}],stopTimer:!1},onShareAppMessage:null,getCartSettle:function(){var e=this;app.wxRequest("/rfid/readRfid",{did:this.data.did},function(t){if(1==t.code){var a=t.data.coupons,i=t.data.ycoid,d=t.data.data.commoditys,o=[],c=[];!!a&&a.forEach(function(e){1==e.status&&(e.textShow=e.dictValue,o.push(e))}),!!d&&d.forEach(function(e){c.push(e.dbid)}),e.setData({dbids:c.join(","),goodsList:d,coupons:o.length>0?[{textShow:"不使用优惠券",cpid:""}].concat(o):[{textShow:"无可用优惠券",cpid:""}],hasCoupons:o.length>0,couponPrice:0,allGoodsPrice:t.data.sumOldDisPrice,allGoodsAndYunPrice:t.data.sumPrice,ycoid:t.data.ycoid,useYcoid:0,ycoidList:i>0?[{textShow:"不使用薏米",ycoid:"0"},{textShow:t.data.ycoid+"薏米",ycoid:t.data.ycoid}]:[{textShow:"没有薏米",ycoid:"0"}],hasYcoid:i>0,yunPrice:t.data.freight});var s=setTimeout(function(){e.readCartSettle(),clearTimeout(s)},5e3)}})},readCartSettle:function(){var e=this;this.data.stopTimer||app.wxRequest("/rfid/readRfid",{did:this.data.did},function(t){if(1==t.code){var a=t.data.data.commoditys,i=[];!!a&&a.forEach(function(e){i.push(e.dbid)}),e.setData({dbids:i.join(","),goodsList:a}),e.countCartSettle();var d=setTimeout(function(){e.readCartSettle(),clearTimeout(d)},5e3)}},null,null,{isLoading:!1})},onHide:function(){this.setData({stopTimer:!0})},onUnload:function(){this.setData({stopTimer:!0})},countCartSettle:function(){var e=this;app.wxRequest("/commodity/settlementRfidCount",{dbids:e.data.dbids,serviceType:e.data.serviceType,cpid:e.data.cpid},function(t){1==t.code&&e.setData({allGoodsAndYunPrice:t.data.sumPrice,yunPrice:t.data.freight,couponPrice:t.data.couponPrice,useYcoid:t.data.useYcoid})})},bindCouponsChange:function(e){var t=this.data.coupons[e.detail.value];this.setData({couponsIndex:e.detail.value,curCoupon:t,serviceType:1,cpid:t.cpid}),t.cpid&&this.countCartSettle()},bindPayTypeChange:function(e){var t=e.detail.value;this.setData({payTypeIndex:t,payType:this.data.payTypeList[t].value})},bindYcoidChange:function(e){this.data.ycoidList[e.detail.value];this.setData({ycoidIndex:e.detail.value,serviceType:2}),this.countCartSettle()},getUserBalance:function(){var e=this;app.wxRequest("/account/userAccountBalance",{},function(t){1==t.code&&e.setData({userBalance:t.data.balance})})},onLoad:function(e){var t=this;t.setData({did:e.did}),t.getCartSettle(e.did),t.getUserBalance()},createOrder:function(){var e=this;if(2==e.data.payType&&e.data.allGoodsAndYunPrice>e.data.userBalance)return void wx.showModal({title:"提 示",content:"您的余额不足，请先去充值或者取消选择微信支付！",cancelText:"取消",confirmText:"去充值",success:function(e){e.confirm&&app.redirect("/pages/user/recharge/index")}});var t={dbids:e.data.dbids,payType:e.data.payType};1==e.data.serviceType?(t.serviceType=e.data.serviceType,t.cpid=e.data.cpid):2==e.data.serviceType&&(t.serviceType=e.data.serviceType),app.wxRequest("/order/saveRfidOrder",t,function(e){1==e.code?app.wxPay(e.data.oid,"/pages/user/center-access/index"):app.showToast("创建订单失败","none")},function(){app.showToast("创建订单错误","none")})}});