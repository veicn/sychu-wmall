"use strict";var app=getApp();Page({data:{goodsListId:[],goodsList:[],allGoodsPrice:0,yunPrice:0,allGoodsAndYunPrice:0,curCoupon:null,couponsIndex:0,serviceType:2,cpid:0,coupons:[],hasCoupons:!1,ycoidList:[],ycoidIndex:0,ycoid:0,useYcoid:0,hasYcoid:!1,userInfo:{},did:"",dbids:[]},onShareAppMessage:null,getCartSettle:function(){var t=this;app.wxRequest("/rfid/readRfid",{did:this.data.did},function(d){if(1==d.code){var i=d.data.coupons,a=d.data.ycoid,e=d.data.commoditys,o=[],c=[];!!i&&i.forEach(function(t){1==t.status&&(t.textShow=t.dictValue,o.push(t))}),!!e&&e.forEach(function(t){c.push(t.dbid)}),t.setData({dbids:c.join(","),goodsList:d.data.commoditys,coupons:o.length>0?[{textShow:"不使用优惠券",cpid:""}].concat(o):[{textShow:"无可用优惠券",cpid:""}],hasCoupons:o.length>0,couponPrice:0,allGoodsPrice:d.data.sumOldDisPrice,allGoodsAndYunPrice:d.data.sumPrice,ycoid:d.data.ycoid,useYcoid:0,ycoidList:a>0?[{textShow:"不使用薏米",ycoid:"0"},{textShow:d.data.ycoid+"薏米",ycoid:d.data.ycoid}]:[{textShow:"没有薏米",ycoid:"0"}],hasYcoid:a>0,yunPrice:d.data.freight})}})},countCartSettle:function(){var t=this;app.wxRequest("/commodity/settlementRfidCount",{dbids:t.data.dbids,serviceType:t.data.serviceType,cpid:t.data.cpid},function(d){1==d.code&&t.setData({allGoodsAndYunPrice:d.data.sumPrice,yunPrice:d.data.freight,couponPrice:d.data.couponPrice,useYcoid:d.data.useYcoid})})},bindCouponsChange:function(t){var d=this.data.coupons[t.detail.value];this.setData({couponsIndex:t.detail.value,curCoupon:d,serviceType:1,cpid:d.cpid}),d.cpid&&this.countCartSettle()},bindYcoidChange:function(t){this.data.ycoidList[t.detail.value];this.setData({ycoidIndex:t.detail.value,serviceType:2}),this.countCartSettle()},onLoad:function(t){var d=this;d.setData({did:t.did}),d.getCartSettle(t.did)},createOrder:function(){var t=this,d={dbids:t.data.dbids,serviceType:t.data.serviceType,cpid:t.data.cpid};app.wxRequest("/order/saveRfidOrder",d,function(t){1==t.code?app.wxPay(t.data.oid,"/pages/user/order-list/index"):app.showToast("创建订单失败","none")},function(){app.showToast("创建订单错误","none")})}});