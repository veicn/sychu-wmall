"use strict";var util=require("../../../utils/util.js"),app=getApp();Page({data:{sizeIndex:0,userSizeList:[],isGetSMSCode:!1,isTimer:!1,isTimerCount:60,smsText:"获取验证码",_t:null,today:util.formatDate(new Date),today100:util.formatDate(new Date("1918-01-01 00:00:00")),mobile:"",code:"",inviteCode:"",usualSize:"",birthday:"选择生日",nextStep:""},onShareAppMessage:null,getUserSizeDicts:function(){var t=this;app.wxRequest("/dict/getDicts",{dictName:"USER_SIZE"},function(e){var a=e.data;1==e.code?t.setData({userSizeList:a.dicts,usualSize:a.dicts[0].dictId}):app.showToast("获取尺码偏好字典失败","none")},function(){app.showToast("获取尺码偏好字典错误","none")})},onLoad:function(t){this.setData({nextStep:t.next||""}),this.getUserSizeDicts()},bindSizeChange:function(t){this.setData({sizeIndex:t.detail.value,usualSize:this.data.userSizeList[t.detail.value].dictId})},bindDateChange:function(t){this.setData({birthday:t.detail.value})},bindMobileBlur:function(t){this.setData({mobile:t.detail.value})},bindCodeBlur:function(t){this.setData({code:t.detail.value})},bindInviteCodeBlur:function(t){this.setData({inviteCode:t.detail.value})},timer:function(){var t=this,e=t.data.isTimerCount;e--,t.setData({isTimer:!0,smsText:e+"s",_t:setTimeout(function(){var e=t.data.isTimerCount;if(e<=1)return void t.clearTimer();var a=--e;t.setData({isTimerCount:a,smsText:a+"s",_t:setTimeout(t.timer,1e3)})},1e3)})},clearTimer:function(){this.setData({isTimer:!1,isTimerCount:60,smsText:"重新获取"}),clearTimeout(this.data._t)},sendSMSCode:function(){var t=this;t.validate("sms")&&(t.setData({isGetSMSCode:!0}),t.data.isTimer||(t.timer(),app.wxRequest("/message/getCode",{mobile:t.data.mobile,type:1},function(){},function(){})))},validate:function(t){var e="";return"submit"==t?"选择生日"==this.data.birthday?e="请选择生日":""==this.data.usualSize?e="请选择尺码偏好":""==this.data.mobile?e="请输入手机号码":/^1\d{10}$/.test(this.data.mobile)?""==this.data.code&&(e="请输入验证码"):e="请输入合法的手机号":"sms"==t&&(""==this.data.mobile?e="请输入手机号码":/^1\d{10}$/.test(this.data.mobile)||(e="请输入合法的手机号")),!e||(app.showToast(e,"none"),!1)},userComplete:function(){var t=this;if(!t.data.isGetSMSCode)return app.showToast("请先获取验证码","none");t.validate("submit")&&app.wxRequest("/user/updateUser",{age:t.data.birthday,usualSize:","+t.data.usualSize+",",mobile:t.data.mobile,code:t.data.code,inviteCode:t.data.inviteCode},function(e){1==e.code?"cart"==t.data.nextStep?app.redirect("/pages/goods/cart/index","switchTab"):"room"==t.data.nextStep?app.redirect("/pages/goods/room/index","switchTab"):"center"==t.data.nextStep?app.redirect("/pages/user/center/index","switchTab"):app.redirect("/pages/index/index","switchTab"):app.showToast(e.message||"保存完善信息失败")},function(t){app.showToast(t.message||"保存完善信息错误")})}});